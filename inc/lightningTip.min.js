var requestUrl=window.location.protocol+"//"+window.location.hostname+window.location.pathname+"inc/lightningTip.php",tipAmounts=[1E4,2E4,4E4],tipAmountsLabel=["10k sat","20k sat","40k sat"],running=!1,invoice,qrCode,defaultGetInvoice,lang=[],qrCodeDataCapacities=[{typeNumber:9,capacity:230},{typeNumber:10,capacity:271},{typeNumber:11,capacity:321},{typeNumber:12,capacity:367},{typeNumber:13,capacity:425},{typeNumber:14,capacity:458},{typeNumber:15,capacity:520},{typeNumber:16,capacity:586},{typeNumber:17,
capacity:644},{typeNumber:18,capacity:718},{typeNumber:19,capacity:792},{typeNumber:20,capacity:858},{typeNumber:21,capacity:929},{typeNumber:22,capacity:1003},{typeNumber:23,capacity:1091},{typeNumber:24,capacity:1171},{typeNumber:25,capacity:1273}];
switch(document.documentElement.lang){case "de":lang={NO_TIP_AMOUNT:"Kein Spendenbetrag gesetzt",MUST_BE_NUMBER:"Spendenbetrag muss eine Zahl sein",AMOUNT_TO_HIGH:"Betrag zu hoch, bitte sende eine normale Bitcoin Transaktion",BACKEND_FAIL:"Lightning Node nicht erreichbar",THANK_YOU:"Vielen Dank f\u00fcr deine Spende!",GENERATE_QR:"Generiere QR"};break;default:lang={NO_TIP_AMOUNT:"No tip amount set",MUST_BE_NUMBER:"Tip amount must be a number",AMOUNT_TO_HIGH:"Amount too high, please send a standard Bitcoin transaction",
BACKEND_FAIL:"Failed to reach Lightning Node",THANK_YOU:"Thank you for your Tip!",GENERATE_QR:"Generate invoice"}}
function showMessage(b,c){running=!1;var a=document.getElementById("lightningTip"),d=document.createElement("section"),e=document.getElementById("lightningTipGetInvoice");d.classList.add("message");d.classList.add(c);d.innerHTML=b;a.append(d);setTimeout(function(){d.classList.add("show")},100);setTimeout(function(){d.classList.remove("show")},1500);setTimeout(function(){d.classList.remove(c)},1700);0!==e.children.length&&(e.innerHTML=defaultGetInvoice)}
function createQRCode(){for(var b=invoice.length,c=26,a=0;a<qrCodeDataCapacities.length;a++){var d=qrCodeDataCapacities[a];if(b<d.capacity){c=d.typeNumber;break}}console.log("Creating QR code with type number: "+c);b=qrcode(c,"L");b.addData(invoice);b.make();return b.createImgTag(6,0)}
function showQRCode(){var b=document.getElementById("lightningTip"),c=document.createElement("section");c.setAttribute("id","qrOverlay");var a=document.createElement("a");a.setAttribute("id","closeQR");var d=document.createElement("div");d.classList.add("close");a.append(d);c.append(a);d=document.createElement("div");d.setAttribute("id","lightningTipQR");d.innerHTML=createQRCode();c.append(d);var e=document.createElement("section");e.setAttribute("id","lightningTipInvoice");e.innerHTML=invoice;c.append(e);
b.append(c);d.addEventListener("click",function(){copyToClipboard(invoice);showMessage("copied to clipboard","success")});b=document.getElementById("lightningTipInvoice").clientWidth+"px";d=d.children[0];d.style.height=b;d.style.width=b;document.getElementById("lightningTipGetInvoice").innerHTML=lang.GENERATE_QR;a.addEventListener("click",function(){c.remove()})}
function showThankYouScreen(){document.getElementById("qrOverlay").remove();var b=document.getElementById("lightningTip"),c=document.createElement("section");c.setAttribute("id","thanksOverlay");var a=document.createElement("p");a.innerHTML=lang.THANK_YOU;c.append(a);c.classList.add("show");b.append(c);document.getElementById("customAmount").classList.remove("active");b=document.getElementById("lightningTipInputs").querySelector("section.amounts").children;for(a=0;a<b.length;a++)console.log(b[a].classList),
b[a].classList.remove("active");var b=document.getElementById("lightningTipAmount"),a=document.getElementById("lightningTipMessage"),d=document.querySelector("#customAmount label");b.value="";a.value="";d.innerHTML="";document.activeElement.blur();setTimeout(function(){c.classList.remove("show")},5E3)}
function listenInvoiceSettled(b){var c=setInterval(function(){var a=new XMLHttpRequest,d=!1;!0!==d&&(a.onreadystatechange=function(){4===a.readyState&&200===a.status&&JSON.parse(a.responseText).settled&&(console.log("Invoice settled"),d=!0,clearInterval(c),showThankYouScreen())},a.open("POST",requestUrl,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send("Action=invoicesettled&r_hash_str="+b))},2E3)}
function getInvoice(){if(!1===running){running=!0;var b=document.getElementById("lightningTipAmount");if(""!==b.value)if(isNaN(b.value))showMessage(lang.MUST_BE_NUMBER,"error");else{var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4===c.readyState)try{var a=JSON.parse(c.responseText);200===c.status?(console.log("Got invoice: "+a.Invoice),console.log("Invoice expires in: "+a.Expiry),console.log("Start listening for invoice to get settled"),listenInvoiceSettled(a.r_hash_str),invoice=a.Invoice,
showQRCode(),running=!1):showMessage(a.Error,"error")}catch(e){4294967<b.value?showMessage(lang.AMOUNT_TO_HIGH,"error"):(console.error(e),showMessage(lang.BACKEND_FAIL,"error"))}};c.open("POST",requestUrl,!0);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");var a="Action=getinvoice&Amount="+parseInt(b.value)+"&Message="+encodeURIComponent(document.getElementById("lightningTipMessage").value);console.log(a);c.send(a);a=document.getElementById("lightningTipGetInvoice");defaultGetInvoice=
a.innerHTML;a.innerHTML="<div class='spinner'></div>"}else showMessage(lang.NO_TIP_AMOUNT,"error")}else console.warn("Last request still pending")}function populateButtons(){for(var b=document.querySelector("section.amounts"),c=0;c<tipAmounts.length;c++){var a=document.createElement("button");a.innerHTML=tipAmountsLabel[c];a.dataset.sat=tipAmounts[c];b.appendChild(a)}}
function attachListeners(){for(var b=document.querySelector("section.amounts"),c=document.getElementById("lightningTipAmount"),a=b.children,b=0;b<a.length;b++)"BUTTON"==a[b].tagName&&a[b].addEventListener("click",function(b){for(var d=0;d<a.length;d++)this!=a[d]?a[d].classList.remove("active"):(this.classList.add("active"),c.value=a[d].dataset.sat,changeFiatLabel());b.preventDefault()});var d=document.getElementById("customAmount");document.getElementById("customAmountLink").addEventListener("click",
function(a){a.preventDefault();d.classList.toggle("active")});c.oninput=changeFiatLabel}function changeFiatLabel(){var b=document.getElementById("lightningTipAmount").value,b=calculateFiatPrice(b);document.querySelector("#customAmount label").innerHTML=b}
function calculateFiatPrice(b){var c=document.querySelector("section.amounts");switch(document.documentElement.lang){case "de":var c=c.dataset.btc_eur,a="de-DE",d="EUR";break;case "en":c=c.dataset.btc_usd;a="en-US";d="USD";break;default:c=c.dataset.btc_usd}return(Math.round(100*(b/1E8*c+1E-5))/100).toLocaleString(a,{style:"currency",currency:d})}
function printFiatPrice(){for(var b=document.querySelector("section.amounts").children,c=0;c<b.length;c++)if("BUTTON"==b[c].tagName){var a=b[c],d=calculateFiatPrice(a.dataset.sat);a.insertAdjacentHTML("beforeend","<span>"+d+"</span>")}}
function getBitcoinPrice(){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var c=JSON.parse(b.responseText),a=document.querySelector("section.amounts");a.dataset.btc_eur=c.eur;a.dataset.btc_usd=c.usd;printFiatPrice()}};b.open("POST",requestUrl,!0);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send("Action=getfiatprice")}
function copyToClipboard(b){if(window.clipboardData&&window.clipboardData.setData)return clipboardData.setData("Text",b);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var c=document.createElement("textarea");c.textContent=b;c.style.position="fixed";document.body.appendChild(c);c.select();try{return document.execCommand("copy")}catch(a){return console.warn("Copy to clipboard failed.",a),!1}finally{document.body.removeChild(c)}}}
function main(){populateButtons();getBitcoinPrice();attachListeners()}main();
