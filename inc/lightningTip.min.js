var requestUrl=window.location.protocol+"//"+window.location.hostname+window.location.pathname+"inc/lightningTip.php",tipAmounts=[1E4,2E4,4E4],tipAmountsLabel=["10k sat","20k sat","40k sat"],running=!1,invoice,qrCode,defaultGetInvoice,lang=[],qrCodeDataCapacities=[{typeNumber:9,capacity:230},{typeNumber:10,capacity:271},{typeNumber:11,capacity:321},{typeNumber:12,capacity:367},{typeNumber:13,capacity:425},{typeNumber:14,capacity:458},{typeNumber:15,capacity:520},{typeNumber:16,capacity:586},{typeNumber:17,
capacity:644},{typeNumber:18,capacity:718},{typeNumber:19,capacity:792},{typeNumber:20,capacity:858},{typeNumber:21,capacity:929},{typeNumber:22,capacity:1003},{typeNumber:23,capacity:1091},{typeNumber:24,capacity:1171},{typeNumber:25,capacity:1273}];
switch(document.documentElement.lang){case "de":lang={NO_TIP_AMOUNT:"Kein Spendenbetrag gesetzt",MUST_BE_NUMBER:"Spendenbetrag muss eine Zahl sein",AMOUNT_TO_HIGH:"Betrag zu hoch, bitte sende eine normale Bitcoin Transaktion",BACKEND_FAIL:"Lightning Node nicht erreichbar",THANK_YOU:"Vielen Dank f\u00fcr deine Spende!",GENERATE_QR:"Generiere QR"};break;default:lang={NO_TIP_AMOUNT:"No tip amount set",MUST_BE_NUMBER:"Tip amount must be a number",AMOUNT_TO_HIGH:"Amount too high, please send a standard Bitcoin transaction",
BACKEND_FAIL:"Failed to reach Lightning Node",THANK_YOU:"Thank you for your Tip!",GENERATE_QR:"Generate invoice"}}
function showMessage(c,a){running=!1;var b=document.getElementById("lightningTip"),d=document.createElement("section"),e=document.getElementById("lightningTipGetInvoice");d.classList.add("message");d.classList.add(a);d.innerHTML=c;b.append(d);setTimeout(function(){d.classList.add("show")},100);setTimeout(function(){d.classList.remove("show")},1500);setTimeout(function(){d.classList.remove(a)},1700);0!==e.children.length&&(e.innerHTML=defaultGetInvoice)}
function createQRCode(){for(var c=invoice.length,a=26,b=0;b<qrCodeDataCapacities.length;b++){var d=qrCodeDataCapacities[b];if(c<d.capacity){a=d.typeNumber;break}}console.log("Creating QR code with type number: "+a);c=qrcode(a,"L");c.addData(invoice);c.make();return c.createImgTag(6,0)}
function showQRCode(){var c=document.getElementById("lightningTip"),a=document.createElement("section");a.setAttribute("id","qrOverlay");var b=document.createElement("a");b.setAttribute("id","closeQR");var d=document.createElement("div");d.classList.add("close");b.append(d);a.append(b);d=document.createElement("div");d.setAttribute("id","lightningTipQR");d.innerHTML=createQRCode();a.append(d);var e=document.createElement("section");e.setAttribute("id","lightningTipInvoice");e.innerHTML=invoice;a.append(e);
c.append(a);d.addEventListener("click",function(){copyToClipboard(invoice);showMessage("copied to clipboard","success")});c=document.getElementById("lightningTipInvoice").clientWidth+"px";d=d.children[0];d.style.height=c;d.style.width=c;document.getElementById("lightningTipGetInvoice").innerHTML=lang.GENERATE_QR;b.addEventListener("click",function(){a.remove()})}
function showThankYouScreen(){document.getElementById("qrOverlay").remove();var c=document.getElementById("lightningTip"),a=document.createElement("section");a.setAttribute("id","thanksOverlay");var b=document.createElement("p");b.innerHTML=lang.THANK_YOU;a.append(b);a.classList.add("show");c.append(a);setTimeout(function(){a.classList.remove("show")},5E3)}
function listenInvoiceSettled(c){var a=setInterval(function(){var b=new XMLHttpRequest,d=!1;!0!==d&&(b.onreadystatechange=function(){4===b.readyState&&200===b.status&&JSON.parse(b.responseText).settled&&(console.log("Invoice settled"),d=!0,clearInterval(a),showThankYouScreen())},b.open("POST",requestUrl,!0),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.send("Action=invoicesettled&r_hash_str="+c))},2E3)}
function getInvoice(){if(!1===running){running=!0;var c=document.getElementById("lightningTipAmount");if(""!==c.value)if(isNaN(c.value))showMessage(lang.MUST_BE_NUMBER,"error");else{var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState)try{var b=JSON.parse(a.responseText);200===a.status?(console.log("Got invoice: "+b.Invoice),console.log("Invoice expires in: "+b.Expiry),console.log("Start listening for invoice to get settled"),listenInvoiceSettled(b.r_hash_str),invoice=b.Invoice,
showQRCode(),running=!1):showMessage(b.Error,"error")}catch(e){4294967<c.value?showMessage(lang.AMOUNT_TO_HIGH,"error"):(console.error(e),showMessage(lang.BACKEND_FAIL,"error"))}};a.open("POST",requestUrl,!0);a.setRequestHeader("Content-type","application/x-www-form-urlencoded");var b="Action=getinvoice&Amount="+parseInt(c.value)+"&Message="+encodeURIComponent(document.getElementById("lightningTipMessage").value);console.log(b);a.send(b);b=document.getElementById("lightningTipGetInvoice");defaultGetInvoice=
b.innerHTML;b.innerHTML="<div class='spinner'></div>"}else showMessage(lang.NO_TIP_AMOUNT,"error")}else console.warn("Last request still pending")}function populateButtons(){for(var c=document.querySelector("section.amounts"),a=0;a<tipAmounts.length;a++){var b=document.createElement("button");b.innerHTML=tipAmountsLabel[a];b.dataset.sat=tipAmounts[a];c.appendChild(b)}}
function attachListeners(){for(var c=document.querySelector("section.amounts"),a=document.getElementById("lightningTipAmount"),b=c.children,c=0;c<b.length;c++)"BUTTON"==b[c].tagName&&b[c].addEventListener("click",function(c){for(var d=0;d<b.length;d++)this!=b[d]?b[d].classList.remove("active"):(this.classList.add("active"),a.value=b[d].dataset.sat,changeFiatLabel());c.preventDefault()});var d=document.getElementById("customAmount");document.getElementById("customAmountLink").addEventListener("click",
function(a){a.preventDefault();d.classList.toggle("active")});a.oninput=changeFiatLabel}function changeFiatLabel(){var c=document.getElementById("lightningTipAmount").value,c=calculateFiatPrice(c);document.querySelector("#customAmount label").innerHTML=c}
function calculateFiatPrice(c){var a=document.querySelector("section.amounts");switch(document.documentElement.lang){case "de":var a=a.dataset.btc_eur,b="de-DE",d="EUR";break;case "en":a=a.dataset.btc_usd;b="en-US";d="USD";break;default:a=a.dataset.btc_usd}return(Math.round(100*(c/1E8*a+1E-5))/100).toLocaleString(b,{style:"currency",currency:d})}
function printFiatPrice(){for(var c=document.querySelector("section.amounts").children,a=0;a<c.length;a++)if("BUTTON"==c[a].tagName){var b=c[a],d=calculateFiatPrice(b.dataset.sat);b.insertAdjacentHTML("beforeend","<span>"+d+"</span>")}}
function getBitcoinPrice(){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4===c.readyState&&200===c.status){var a=JSON.parse(c.responseText),b=document.querySelector("section.amounts");b.dataset.btc_eur=a.eur;b.dataset.btc_usd=a.usd;printFiatPrice()}};c.open("POST",requestUrl,!0);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.send("Action=getfiatprice")}
function copyToClipboard(c){if(window.clipboardData&&window.clipboardData.setData)return clipboardData.setData("Text",c);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var a=document.createElement("textarea");a.textContent=c;a.style.position="fixed";document.body.appendChild(a);a.select();try{return document.execCommand("copy")}catch(b){return console.warn("Copy to clipboard failed.",b),!1}finally{document.body.removeChild(a)}}}
function main(){populateButtons();getBitcoinPrice();attachListeners()}main();
