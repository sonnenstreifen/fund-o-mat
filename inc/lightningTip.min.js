function getInvoice(){if(!1===running){running=!0;var e=document.getElementById("lightningTipAmount");if(""!==e.value)if(isNaN(e.value))showErrorMessage(lang.MUST_BE_NUMBER);else{var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)try{var e=JSON.parse(n.responseText);if(200===n.status){console.log("Got invoice: "+e.Invoice),console.log("Invoice expires in: "+e.Expiry),console.log("Starting listening for invoice to get settled"),listenInvoiceSettled(e.r_hash_str),invoice=e.Invoice;var t=document.getElementById("lightningTip");t.innerHTML="<div id='lightningTipQR'></div>",t.innerHTML+="<section class='lightningTipInvoice' id='lightningTipInvoice' >"+invoice+"</section>",t.innerHTML+="<div id='lightningTipTools'><button class='lightningTipButton' id='lightningTipCopy'>Copy</button><button class='lightningTipButton' id='lightningTipOpen'>Open</button><div id='lightningTipExpiry'></div></div>",starTimer(e.Expiry,document.getElementById("lightningTipExpiry")),document.getElementById("lightningTipTools").style.height=document.getElementById("lightningTipCopy").clientHeight+"px",document.getElementById("lightningTipOpen").onclick=function(){location.href="lightning:"+e.Invoice},showQRCode(),running=!1}else showErrorMessage(e.Error)}catch(e){console.error(e),showErrorMessage(lang.BACKEND_FAIL)}},n.open("POST",requestUrl,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded");var t="Action=getinvoice&Amount="+parseInt(e.value)+"&Message="+encodeURIComponent(document.getElementById("lightningTipMessage").value);console.log(t),n.send(t);var i=document.getElementById("lightningTipGetInvoice");defaultGetInvoice=i.innerHTML,i.innerHTML="<div class='spinner'></div>"}else showErrorMessage(lang.NO_TIP_AMOUNT)}else console.warn("Last request still pending")}function listenInvoiceSettled(e){var n=setInterval(function(){var t=new XMLHttpRequest,i=!1;if(1!=i){t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){JSON.parse(t.responseText).settled&&(console.log("Invoice settled"),i=!0,clearInterval(n),showThankYouScreen())}},t.open("POST",requestUrl,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded");var o="Action=invoicesettled&r_hash_str="+e;t.send(o)}},2e3)}function showThankYouScreen(){var e=document.getElementById("lightningTip");e.innerHTML="<p id='lightningTipLogo'>⚡</p>",e.innerHTML+="<p id='lightningTipFinished'>"+lang.THANK_YOU+"</p>"}function starTimer(e,n){showTimer(e,n);var t=setInterval(function(){e>1?(e--,showTimer(e,n)):(showExpired(),clearInterval(t))},1e3)}function showTimer(e,n){var t=Math.floor(e%60),i=Math.floor(e/60%60),o=Math.floor(e/3600%24);t=addLeadingZeros(t),i=addLeadingZeros(i),n.innerHTML=o>0?o+":"+i+":"+t:i+":"+t}function showExpired(){var e=document.getElementById("lightningTip");e.innerHTML="<p id='lightningTipLogo'>⚡</p>",e.innerHTML+="<p id='lightningTipFinished'>"+lang.INVOICE_EXPIRED+"</p>"}function addLeadingZeros(e){return("0"+e).slice(-2)}function showQRCode(){var e=document.getElementById("lightningTipQR");createQRCode(),e.innerHTML=qrCode;var n=document.getElementById("lightningTipInvoice").clientWidth+"px",t=e.children[0];t.style.height=n,t.style.width=n}function createQRCode(){for(var e=invoice.length,n=26,t=0;t<qrCodeDataCapacities.length;t++){var i=qrCodeDataCapacities[t];if(e<i.capacity){n=i.typeNumber;break}}console.log("Creating QR code with type number: "+n);var o=qrcode(n,"L");o.addData(invoice),o.make(),qrCode=o.createImgTag(6,0)}function showErrorMessage(e){running=!1,console.error(e);var n=document.getElementById("lightningTipError");n.parentElement.style.marginTop="0.5em",n.innerHTML=e,n.classList.add("show"),setTimeout(function(){n.classList.remove("show")},2e3);var t=document.getElementById("lightningTipGetInvoice");0!==t.children.length&&(t.innerHTML=defaultGetInvoice)}function divRestorePlaceholder(e){"<br>"!==e.innerHTML&&"<div><br></div>"!==e.innerHTML||(e.innerHTML="")}function getVal(e){var n=window.location.search.match(new RegExp("(?:[?&]"+e+"=)([^&]+)"));return n?n[1]:null}var requestUrl=window.location.protocol+"//"+window.location.hostname+"/lightning/lightningTip.php",running=!1,invoice,qrCode,defaultGetInvoice,qrCodeDataCapacities=[{typeNumber:9,capacity:230},{typeNumber:10,capacity:271},{typeNumber:11,capacity:321},{typeNumber:12,capacity:367},{typeNumber:13,capacity:425},{typeNumber:14,capacity:458},{typeNumber:15,capacity:520},{typeNumber:16,capacity:586},{typeNumber:17,capacity:644},{typeNumber:18,capacity:718},{typeNumber:19,capacity:792},{typeNumber:20,capacity:858},{typeNumber:21,capacity:929},{typeNumber:22,capacity:1003},{typeNumber:23,capacity:1091},{typeNumber:24,capacity:1171},{typeNumber:25,capacity:1273}];switch(document.documentElement.lang){case"de":lang={NO_TIP_AMOUNT:"Kein Spendenbetrag gesetzt",MUST_BE_NUMBER:"Spendenbetrag muss eine Zahl sein",BACKEND_FAIL:"Lightning Node nicht erreichbar",THANK_YOU:"Vielen Dank für deine Spende!",INVOICE_EXPIRED:"Der QR Code ist abgelaufen, bitte generiere einen neuen indem du die Seite erneut aufrufst!"};break;case"en":lang={NO_TIP_AMOUNT:"No tip amount set",MUST_BE_NUMBER:"Tip amount must be a number",BACKEND_FAIL:"Failed to reach Lightning Node",THANK_YOU:"Thank you for your Tip!",INVOICE_EXPIRED:"Your tip request expired!"}}var testnet=getVal("testnet");console.log("Testnet = "+testnet),null!==testnet&&(requestUrl+="?testnet=1",console.log("requestUrl = "+requestUrl));